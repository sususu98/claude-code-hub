name: Claude CI Auto-Fix

on:
  workflow_run:
    workflows: ["PR Build Check", "Non-Main Branch CI/CD"]
    types: [completed]

jobs:
  auto-fix:
    # Only run on failure, skip Claude's own fix branches
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      !startsWith(github.event.workflow_run.head_branch, 'claude-fix-')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      actions: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let errorLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logLines = logs.data.split('\n');
                const relevantLogs = logLines.slice(-3000).join('\n');
                errorLogs.push({
                  jobName: job.name,
                  logs: relevantLogs
                });
              } catch (error) {
                console.log(`Failed to get logs for job ${job.name}: ${error.message}`);
              }
            }

            const pullRequests = ${{ toJSON(github.event.workflow_run.pull_requests) }};
            const hasPR = pullRequests && pullRequests.length > 0;

            return {
              runUrl: run.data.html_url,
              workflowName: run.data.name,
              failedJobs: failedJobs.map(j => j.name),
              errorLogs: errorLogs,
              hasPR: hasPR,
              prNumber: hasPR ? pullRequests[0].number : null,
              headBranch: '${{ github.event.workflow_run.head_branch }}'
            };

      - name: Run Claude Code for CI Fix
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT }}

          prompt: |
            You are a CI failure auto-fixer for the repository ${{ github.repository }}.

            Context:
            - Workflow: ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}
            - Failed run: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            - Branch: ${{ fromJSON(steps.failure_details.outputs.result).headBranch }}
            - Has PR: ${{ fromJSON(steps.failure_details.outputs.result).hasPR }}
            - PR Number: ${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
            - Failed jobs: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}

            Error logs:
            ```
            ${{ toJSON(fromJSON(steps.failure_details.outputs.result).errorLogs) }}
            ```

            Task: Analyze and fix the CI failure.

            ## Instructions:

            1. **Analyze the error logs** to identify:
               - ESLint/Prettier errors â†’ Run `bun run lint:fix` or `bun run format`
               - TypeScript errors â†’ Fix type definitions
               - Test failures â†’ Fix tests or code
               - Build errors â†’ Check dependencies and config

            2. **Apply fixes**:
               - Use Read tool to examine files
               - Use Edit tool to fix issues
               - Run fix commands if applicable

            3. **Verify fixes**:
               - Run `bun run typecheck` for type errors
               - Run `bun run lint` for lint errors

            4. **Commit and push**:

               **If has PR (hasPR = true)**:
               ```bash
               git checkout -b claude-fix-pr-${{ fromJSON(steps.failure_details.outputs.result).prNumber }}-${{ github.run_id }}
               git add .
               git commit -m "fix: auto-fix CI failures in ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}"
               git push origin claude-fix-pr-${{ fromJSON(steps.failure_details.outputs.result).prNumber }}-${{ github.run_id }}

               # Create PR to the original branch
               gh pr create \
                 --base ${{ fromJSON(steps.failure_details.outputs.result).headBranch }} \
                 --title "ðŸ¤– Auto-fix CI failures for PR #${{ fromJSON(steps.failure_details.outputs.result).prNumber }}" \
                 --body "## Auto-fix CI Failures

               Original PR: #${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
               Failed CI: [${{ fromJSON(steps.failure_details.outputs.result).workflowName }}](${{ fromJSON(steps.failure_details.outputs.result).runUrl }})

               ### Fixes Applied:
               [Describe your fixes]

               ---
               ðŸ¤– *Auto-generated by Claude AI*"
               ```

               **If no PR (hasPR = false)**:
               ```bash
               git add .
               git commit -m "fix: auto-fix CI failures in ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}"
               git push origin ${{ fromJSON(steps.failure_details.outputs.result).headBranch }}
               ```

            ## Important:
            - Only fix obvious, safe issues (lint, format, simple type errors)
            - Don't make changes that alter functionality
            - If unsure, document what couldn't be fixed
            - Don't include [skip ci] - let CI run again

          claude_args: "--max-turns 999 --allowedTools Read,Write,Edit,Bash(gh:*),Bash(git:*),Bash(bun:*),Bash(npm:*)"
          use_commit_signing: false

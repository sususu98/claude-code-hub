name: Claude PR Size Check

on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  pr-size-check:
    # Skip bot actors
    if: "!endsWith(github.actor, '[bot]')"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run Claude Code for PR Size Check
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT }}
          # Allow external contributors (fork PRs) to trigger this workflow
          allowed_non_write_users: "*"

          prompt: |
            You are a PR size analyzer for the repository ${{ github.repository }}.

            Task: Check if PR #${{ github.event.pull_request.number }} is appropriately sized and suggest splitting if needed.

            ## Instructions:

            1. **Get PR statistics**:
               ```bash
               gh pr view ${{ github.event.pull_request.number }} --json additions,deletions,changedFiles
               gh pr diff ${{ github.event.pull_request.number }} --name-only
               ```

            2. **Analyze PR size**:
               - Count total lines changed (additions + deletions)
               - Count number of files changed
               - Identify different concerns being addressed

            3. **Size thresholds**:
               - **XS**: < 50 lines, < 5 files
               - **S**: < 200 lines, < 10 files
               - **M**: < 500 lines, < 20 files
               - **L**: < 1000 lines, < 30 files
               - **XL**: > 1000 lines or > 30 files

            4. **Apply size label**:
               ```bash
               gh pr edit ${{ github.event.pull_request.number }} --add-label "size/M"
               ```

            5. **For large PRs (L or XL)**, post a comment with splitting suggestions:
               ```bash
               gh pr comment ${{ github.event.pull_request.number }} --body "Your suggestion"
               ```

            ## Large PR Comment Template:
            ```markdown
            ## ðŸ“Š PR Size Analysis

            This PR is **[SIZE]** with **X lines** changed across **Y files**.

            Large PRs are harder to review and more likely to introduce bugs.

            ### ðŸ”€ Suggested Split:

            Based on the changes, this PR could be split into:

            1. **PR 1**: [Description] - [files]
            2. **PR 2**: [Description] - [files]
            3. **PR 3**: [Description] - [files]

            ### Why Split?
            - Easier to review
            - Faster CI feedback
            - Easier to revert if needed
            - Better git history

            ---
            ðŸ¤– *Automated analysis by Claude AI*
            ```

            ## Important:
            - For XS, S, M sizes: Only apply label, no comment needed
            - For L, XL sizes: Apply label AND post splitting suggestion
            - Identify logical boundaries for splitting (different features, different components)
            - Don't count generated files (package-lock.json, etc.) in size calculation

          claude_args: "--max-turns 999 --allowedTools Bash(gh:*)"
          use_commit_signing: false

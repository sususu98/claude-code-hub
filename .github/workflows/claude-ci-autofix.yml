name: Claude CI Auto-Fix

on:
  workflow_run:
    workflows: ["PR Build Check", "Non-Main Branch CI/CD"]
    types: [completed]

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘æˆ–è¢«å…¶ä»– workflow è°ƒç”¨
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Task type (ci-fix or sync-dev)'
        required: true
        default: 'ci-fix'
        type: choice
        options:
          - ci-fix
          - sync-dev
      target_branch:
        description: 'Target branch for sync-dev task'
        required: false
        default: 'dev'
        type: string
      source_branch:
        description: 'Source branch for sync-dev task'
        required: false
        default: 'main'
        type: string
      release_tag:
        description: 'Release tag that triggered sync'
        required: false
        type: string

jobs:
  # Job for dev branch sync (triggered by workflow_dispatch)
  sync-dev:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task_type == 'sync-dev'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      # å®‰å…¨éªŒè¯ï¼šåªå…è®¸ dev åˆ†æ”¯ä½œä¸ºç›®æ ‡ï¼Œmain åˆ†æ”¯ä½œä¸ºæº
      - name: Validate branch parameters
        run: |
          TARGET="${{ github.event.inputs.target_branch }}"
          SOURCE="${{ github.event.inputs.source_branch }}"

          if [[ "$TARGET" != "dev" ]]; then
            echo "::error::Security: Only 'dev' branch is allowed as target. Got: $TARGET"
            exit 1
          fi

          if [[ "$SOURCE" != "main" ]]; then
            echo "::error::Security: Only 'main' branch is allowed as source. Got: $SOURCE"
            exit 1
          fi

          echo "Branch validation passed: syncing $SOURCE -> $TARGET"

      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.target_branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Run Claude Code for Dev Sync
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

          prompt: |
            You are a Git branch synchronization assistant for the repository ${{ github.repository }}.

            Context:
            - Source branch: ${{ github.event.inputs.source_branch }} (contains new release)
            - Target branch: ${{ github.event.inputs.target_branch }} (needs to be synced)
            - Release tag: ${{ github.event.inputs.release_tag }}

            Task: Sync the target branch with source branch while preserving target branch's ahead commits.

            ## Instructions:

            1. **Analyze the situation**:
               ```bash
               git fetch origin
               git checkout ${{ github.event.inputs.target_branch }}
               git log --oneline -10
               git rev-list --count origin/${{ github.event.inputs.source_branch }}..HEAD
               ```

            2. **Attempt rebase**:
               ```bash
               git rebase origin/${{ github.event.inputs.source_branch }}
               ```

            3. **If conflicts occur**:
               - Use `git status` to identify conflicting files
               - Read conflicting files with Read tool
               - Analyze the conflict markers (<<<<<<<, =======, >>>>>>>)
               - Resolve conflicts by choosing the correct version or merging changes
               - Use Edit tool to fix conflicts
               - Run `git add <resolved-file>` for each resolved file
               - Continue with `git rebase --continue`
               - Repeat until all conflicts are resolved

            4. **Verify the result**:
               ```bash
               bun install
               bun run typecheck
               bun run lint
               ```

            5. **Push the synced branch**:
               ```bash
               git push origin ${{ github.event.inputs.target_branch }} --force-with-lease
               ```

            ## Conflict Resolution Guidelines:
            - For VERSION file: Keep the source branch version (newer release)
            - For package.json/bun.lockb: Accept source changes, then run `bun install`
            - For code changes: Prefer target branch changes (feature work) unless they conflict with critical fixes
            - For config files: Merge both changes if possible

            ## Important:
            - Preserve all commits from target branch that are ahead of source
            - Don't lose any feature work
            - If you cannot resolve a conflict, document it clearly and abort

          claude_args: "--max-turns 999 --allowedTools Read,Write,Edit,Bash(gh:*),Bash(git:*),Bash(bun:*),Bash(npm:*)"
          use_commit_signing: false

  auto-fix:
    # Only run on failure, skip Claude's own fix branches
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'failure' &&
       !startsWith(github.event.workflow_run.head_branch, 'claude-fix-')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.task_type == 'ci-fix')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      actions: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ github.event.workflow_run.id }}
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');

            let errorLogs = [];
            for (const job of failedJobs) {
              try {
                const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logLines = logs.data.split('\n');
                const relevantLogs = logLines.slice(-3000).join('\n');
                errorLogs.push({
                  jobName: job.name,
                  logs: relevantLogs
                });
              } catch (error) {
                console.log(`Failed to get logs for job ${job.name}: ${error.message}`);
              }
            }

            const pullRequests = ${{ toJSON(github.event.workflow_run.pull_requests) }};
            const hasPR = pullRequests && pullRequests.length > 0;

            return {
              runUrl: run.data.html_url,
              workflowName: run.data.name,
              failedJobs: failedJobs.map(j => j.name),
              errorLogs: errorLogs,
              hasPR: hasPR,
              prNumber: hasPR ? pullRequests[0].number : null,
              headBranch: '${{ github.event.workflow_run.head_branch }}'
            };

      - name: Run Claude Code for CI Fix
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT }}

          prompt: |
            You are a CI failure auto-fixer for the repository ${{ github.repository }}.

            Context:
            - Workflow: ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}
            - Failed run: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            - Branch: ${{ fromJSON(steps.failure_details.outputs.result).headBranch }}
            - Has PR: ${{ fromJSON(steps.failure_details.outputs.result).hasPR }}
            - PR Number: ${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
            - Failed jobs: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}

            Error logs:
            ```
            ${{ toJSON(fromJSON(steps.failure_details.outputs.result).errorLogs) }}
            ```

            Task: Analyze and fix the CI failure.

            ## Instructions:

            1. **Analyze the error logs** to identify:
               - ESLint/Prettier errors â†’ Run `bun run lint:fix` or `bun run format`
               - TypeScript errors â†’ Fix type definitions
               - Test failures â†’ Fix tests or code
               - Build errors â†’ Check dependencies and config

            2. **Apply fixes**:
               - Use Read tool to examine files
               - Use Edit tool to fix issues
               - Run fix commands if applicable

            3. **Verify fixes**:
               - Run `bun run typecheck` for type errors
               - Run `bun run lint` for lint errors

            4. **Commit and push**:

               **If has PR (hasPR = true)**:
               ```bash
               git checkout -b claude-fix-pr-${{ fromJSON(steps.failure_details.outputs.result).prNumber }}-${{ github.run_id }}
               git add .
               git commit -m "fix: auto-fix CI failures in ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}"
               git push origin claude-fix-pr-${{ fromJSON(steps.failure_details.outputs.result).prNumber }}-${{ github.run_id }}

               # Create PR to the original branch
               gh pr create \
                 --base ${{ fromJSON(steps.failure_details.outputs.result).headBranch }} \
                 --title "ðŸ¤– Auto-fix CI failures for PR #${{ fromJSON(steps.failure_details.outputs.result).prNumber }}" \
                 --body "## Auto-fix CI Failures

               Original PR: #${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
               Failed CI: [${{ fromJSON(steps.failure_details.outputs.result).workflowName }}](${{ fromJSON(steps.failure_details.outputs.result).runUrl }})

               ### Fixes Applied:
               [Describe your fixes]

               ---
               ðŸ¤– *Auto-generated by Claude AI*"
               ```

               **If no PR (hasPR = false)**:
               ```bash
               git add .
               git commit -m "fix: auto-fix CI failures in ${{ fromJSON(steps.failure_details.outputs.result).workflowName }}"
               git push origin ${{ fromJSON(steps.failure_details.outputs.result).headBranch }}
               ```

            ## Important:
            - Only fix obvious, safe issues (lint, format, simple type errors)
            - Don't make changes that alter functionality
            - If unsure, document what couldn't be fixed
            - Don't include [skip ci] - let CI run again

          claude_args: "--max-turns 999 --allowedTools Read,Write,Edit,Bash(gh:*),Bash(git:*),Bash(bun:*),Bash(npm:*)"
          use_commit_signing: false

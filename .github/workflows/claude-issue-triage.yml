name: Claude Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Run Claude Code for Issue Triage
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GH_PAT }}

          prompt: |
            You are an issue triage assistant for the repository ${{ github.repository }}.

            Task: Analyze and label the newly opened issue #${{ github.event.issue.number }}.

            ## Instructions:

            1. **Read the issue** using `gh issue view ${{ github.event.issue.number }}`

            2. **Fetch available labels** using `gh label list`

            3. **Analyze the issue** and determine:
               - **Type**: bug, feature-request, question, documentation, enhancement
               - **Priority**: P1 (critical), P2 (high), P3 (medium), P4 (low)
               - **Component**: api, ui, database, auth, proxy, etc.

            4. **Apply labels** using `gh issue edit ${{ github.event.issue.number }} --add-label "label1,label2"`

            ## Label Guidelines:

            - **bug**: Issue describes unexpected behavior or errors
            - **feature-request**: Issue requests new functionality
            - **question**: Issue asks for help or clarification
            - **documentation**: Issue relates to docs improvement
            - **enhancement**: Issue suggests improvement to existing feature

            - **P1-critical**: System down, data loss, security vulnerability
            - **P2-high**: Major feature broken, no workaround
            - **P3-medium**: Feature partially broken, workaround exists
            - **P4-low**: Minor issue, cosmetic problems

            ## Important:
            - Do NOT post any comments - only apply labels
            - Be conservative with priority labels
            - Apply at most 3-4 labels total
            - If unsure about a label, don't apply it

          claude_args: "--max-turns 999 --allowedTools Bash(gh:*)"
          use_commit_signing: false
